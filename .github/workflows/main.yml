name: Stable-Tailscale-RDP-Final
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Tailscale Install
        shell: powershell
        run: |
          Write-Host "Downloading Tailscale..."
          iwr -useb https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Write-Host "Installing Tailscale..."
          start-process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          Write-Host "Tailscale Installation Completed."

      - name: Tailscale Connect
        shell: powershell
        run: |
          Write-Host "Connecting to Tailscale Network..."
          # Aapki Auth Key yahan use ho rahi hai
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=tskey-auth-kF29Zucb5721CNTRL-Hjf7uGto6FLiKjgmKve3FLiKeMfUjnku --accept-dns=false --hostname=GitHub-RDP
          Write-Host "Connection Successful!"

      - name: Enable Remote Desktop & Fix Password
        shell: powershell
        run: |
          Write-Host "Optimizing Windows RDP Settings..."
          # RDP enable karna
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Sabse reliable method password change karne ka
          net user runneradmin "RDP@Secure#123"
          
          Write-Host "Credentials Set -> User: runneradmin | Pass: RDP@Secure#123"

      - name: Keep RDP Alive
        shell: powershell
        run: |
          Write-Host "RDP is now active. Check your Tailscale Dashboard for 'GitHub-RDP' IP."
          $i = 0
          while($i -lt 360) {
            $time = Get-Date -Format "HH:mm:ss"
            Write-Host "[$time] Status: Online and Connected"
            Start-Sleep -Seconds 60
            $i++
          }
