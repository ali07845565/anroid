name: Android Emulator Remote Access (scrcpy style)

on:
  workflow_dispatch:

jobs:
  android-remote:
    runs-on: macos-latest          # macOS best for Android emulator speed
    timeout-minutes: 360           # 6 hours max, cancel kar sakte ho

    steps:
      - name: Enable KVM if Linux (skip for macOS)
        if: runner.os == 'Linux'
        run: |
          sudo modprobe kvm
          sudo chown $USER /dev/kvm

      - name: Setup Android SDK & Emulator
        uses: hannesa2/action-android/emulator-run-cmd@v1
        with:
          api: 34                       # Android 14
          abi: x86_64                   # fastest on macOS
          cmd: emulator -avd test -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect

      - name: Wait for Emulator to Boot
        run: |
          adb wait-for-device
          adb shell input keyevent 82 &  # unlock if needed
          sleep 30
          adb devices

      - name: Install scrcpy (on runner)
        run: |
          brew install scrcpy
          # ya manual download if brew nahi chalta

      - name: Start scrcpy server on emulator (TCP mode)
        run: |
          # scrcpy ko TCP par emulator ke saath connect karne ke liye
          adb reverse tcp:27183 tcp:27183
          scrcpy --tcpip --no-display --stay-awake --turn-screen-off --power-off-on-close &
          echo "scrcpy server started on port 27183"

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.76.1_amd64.pkg -o tailscale.pkg
          sudo installer -pkg tailscale.pkg -target /
          rm tailscale.pkg

      - name: Connect Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -z "$TS_AUTHKEY" ]; then
            echo "Add TAILSCALE_AUTH_KEY in repo secrets!"
            exit 1
          fi
          
          sudo tailscale up --authkey=$TS_AUTHKEY --accept-routes --hostname="android-emulator-${{ github.run_id }}"
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
          echo "Waiting for Tailscale..."
          sleep 15

      - name: Show Access Info
        run: |
          echo ""
          echo "====================================="
          echo " Android Emulator Remote Access"
          echo "====================================="
          echo "Tailscale IP : ${{ env.TAILSCALE_IP }}"
          echo "scrcpy Port  : 27183"
          echo ""
          echo "On your local PC/phone:"
          echo "1. Tailscale join karo (same network)"
          echo "2. scrcpy --tcpip=${{ env.TAILSCALE_IP }}:27183"
          echo "   (ya scrcpy app use karo)"
          echo ""
          echo "Username/Password ki zaroorat nahi - direct control"
          echo "====================================="

      - name: Keep Alive (cancel workflow jab khatam karna ho)
        run: |
          echo "Emulator running... Manually cancel the workflow when done."
          while true; do
            echo "$(date) - Still active"
            sleep 300
          done
