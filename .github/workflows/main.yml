name: Android Emulator Remote Access (scrcpy style)

on:
  workflow_dispatch:

jobs:
  android-remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Setup Environment
        run: |
          brew install android-commandlinetools
          echo 'export ANDROID_HOME=$HOME/Library/Android/sdk' >> $GITHUB_ENV
          echo 'export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools' >> $GITHUB_ENV

      - name: Install Android SDK Components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "system-images;android-34;google_apis;x86_64" "emulator"
          sdkmanager --licenses | grep -v "WARNING"

      - name: Create AVD
        run: |
          avdmanager create avd -n test_avd -k "system-images;android-34;google_apis;x86_64" -d pixel --force

      - name: Launch Emulator
        run: |
          nohup emulator -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          sleep 30
          adb wait-for-device
          echo "Emulator ready!"

      - name: Install scrcpy
        run: |
          brew install scrcpy
          echo "scrcpy installed"

      - name: Setup scrcpy Server
        run: |
          adb reverse tcp:27183 tcp:27183
          scrcpy --tcpip --no-display --stay-awake --turn-screen-off --power-off-on-close &
          echo "scrcpy server running on port 27183"
          sleep 5

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.76.1_amd64.pkg -o tailscale.pkg
          sudo installer -pkg tailscale.pkg -target /
          rm tailscale.pkg

      - name: Connect Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -z "$TS_AUTHKEY" ]; then
            echo "‚ùå Error: TAILSCALE_AUTH_KEY secret missing!"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Add TAILSCALE_AUTH_KEY"
            exit 1
          fi
          
          sudo tailscale up --authkey=$TS_AUTHKEY --accept-routes --hostname="android-emulator-${{ github.run_id }}" --reset
          
          TS_IP=$(tailscale ip -4)
          echo "‚úÖ Tailscale IP: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
          sleep 10

      - name: Show Access Instructions
        run: |
          echo ""
          echo "üéÆ ANDROID EMULATOR READY FOR REMOTE ACCESS üéÆ"
          echo "============================================================="
          echo "üìç Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "üîå scrcpy Port: 27183"
          echo "============================================================="
          echo ""
          echo "üì± APNE LOCAL DEVICE PAR YE STEPS FOLLOW KARO:"
          echo "1. Tailscale install karo[](https://tailscale.com)"
          echo "2. Same Tailscale account se login karo"
          echo "3. scrcpy install karo[](https://github.com/Genymobile/scrcpy)"
          echo ""
          echo "üíª COMMAND RUN KARO:"
          echo "scrcpy --tcpip=${{ env.TAILSCALE_IP }}:27183"
          echo ""
          echo "‚úÖ Ab Android emulator ko mouse/keyboard se control kar sakte ho!"
          echo "‚ö†Ô∏è  Workflow ko manually cancel karo jab kaam khatam ho"
          echo "============================================================="

      - name: Keep Session Active
        run: |
          echo "Emulator active... Workflow cancel karo jab khatam karna ho"
          while true; do
            echo "$(date) - Still running..."
            sleep 300
          done
